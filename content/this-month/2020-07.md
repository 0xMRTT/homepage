+++
title = "This Month in Rust OSDev (July 2020)"
date = 0000-01-01

[extra]
month = "July 2020"
authors = [
    "phil-opp",
    "IsaacWoods",
    # add yourself here
]
+++

Welcome to a new issue of _"This Month in Rust OSDev"_. In these posts, we will give a regular overview of notable changes in the Rust operating system development ecosystem.

<!-- more -->

This series is openly developed [on GitHub](https://github.com/rust-osdev/homepage/). Feel free to open pull requests there with content you would like to see in the next issue. If you find some issues on this page, please report them by [creating an issue](https://github.com/rust-osdev/homepage/issues/new).

<!--
    This is a draft for the upcoming "This Month in Rust OSDev (July 2020)" post.
    Feel free to create pull requests against the `next` branch to add your
    content here.

    Please take a look at the past posts on https://rust-osdev.com/ to see the
    general structure of these posts.
-->

## Project Updates

In this section, we give an overview of notable changes to the projects hosted under the [`rust-osdev`] organization.

[`rust-osdev`]: https://github.com/rust-osdev/about

### [`x86_64`](https://github.com/rust-osdev/x86_64)

The `x86_64` crate provides various abstractions for `x86_64` systems, including wrappers for CPU instructions, access to processor-specific registers, and abstraction types for architecture-specific structures such as page tables and descriptor tables.

In July, …

### [`spinning_top`](https://github.com/rust-osdev/spinning_top)

The `spinning_top` crate provides a simple spinlock implementation based on the abstractions of the [`lock_api`](https://docs.rs/lock_api/0.4.1/lock_api/) crate. We created the crate to provide an alternative to the no-longer maintained [`spin`](https://github.com/mvdnes/spin-rs) crate.

This month, …

### [`acpi`](https://github.com/rust-osdev/acpi)

The `acpi` repository contains crates for parsing the ACPI tables – data structures that the firmware of modern computers use to relay information about the hardware to the OS. This month saw some substantial improvements to our AML handling:

- Objects defined by AML tables exist within a namespace, with objects referred to by paths such as `\_SB.PCI0.ISA.COM1`. Until now, we represented this namespace using a `BTreeMap` between the path (allocated on the heap) and a handle to the
object, meaning that there was both a heap-allocated container, and a heap allocation for every single path within the namespace. [In this PR](https://github.com/rust-osdev/acpi/pull/72), I moved the library to use a new representation that has
a `BTreeMap` for each *level* of the namespace. Because each level of the path can only be 4 characters long (`_SB`, `PCI0`, `ISA`, and `COM1` are the *name segments* in the example above), storing the path of each level no longer requires a heap
allocation per object, which reduces the heap-burden of the library significantly.
- Some more opcodes were implemented: `Target`, `DefShiftLeft`, `DefShiftRight`, `DefLOr`, and `DefAnd`. These all appear in QEMU's tables.
- [A fairly large PR](https://github.com/rust-osdev/acpi/pull/73) was merged that provides the ability to traverse the namespace and initialize devices - this is a mechanism that ACPI provides that allows an OS to initialize hardware that it does
not have drivers for, and is a compulsory step in getting modern chipsets to function properly. This required us to build up a lot of functionality, including namespace traversal, reading and writing from *operation regions*, recursively invoking
control methods, and asking the OS to perform hardware configuration for us (such as reading and writing to IO ports and PCI configuration space). There is still a lot of work in getting all of this working robustly, but this is a great start.

## Personal Projects

In this section, we describe updates to personal projects that are not directly related to the `rust-osdev` organization. Feel free to [create a pull request](https://github.com/rust-osdev/homepage/pulls) with the updates of your OS project for the next post.

### [`phil-opp/blog_os`](https://github.com/phil-opp/blog_os)

<span class="gray">(Section written by [@phil-opp](https://github.com/phil-opp))</span>

This month, …

### [`IsaacWoods/pebble`](https://github.com/IsaacWoods/pebble)

<span class="gray">(Section written by [@IsaacWoods](https://github.com/IsaacWoods))</span>

Between my work on `acpi` and university commitments, I have not had much time to work on Pebble this month, but
some small clean-ups were made:
- The migration from Travis CI to Github Actions was completed, allowing Pebble to be emulated on CI.
- Pebble uses a HAL (hardware abstraction layer) to separate hardware access from kernel logic. Various parts of the `x86_64` implementation of the HAL were made common to support code-reuse across architectures.
- Some [tests](https://github.com/IsaacWoods/pebble/blob/master/kernel/src/memory/buddy_allocator.rs#L202) were added to the buddy allocator (Pebble's physical memory manager). This was to rule out physical memory
allocation as the cause of a bug where user stacks are occasionally corrupted at the userspace-kernel boundary, which unfortunately has still not been fixed.
- Our [algorithm](https://github.com/IsaacWoods/pebble/blob/master/kernel/hal_x86_64/src/paging.rs#L376-L481) for efficiently mapping arbitrary areas was rewritten and extended to support 1GiB pages.
- Work has started on a *topology layer* - data structures that represent features of the platform such as processors, caches, [NUMA](https://en.wikipedia.org/wiki/Non-uniform_memory_access) nodes, and
microarchitectural information. This will help in allowing Pebble to make more intelligent decisions about scheduling and resource usage in the future.

## Join Us?

Are you interested in Rust-based operating system development? Our `rust-osdev` organization is always open to new members and new projects. Just let us know if you want to join! A good way for getting in touch is our [gitter channel](https://gitter.im/rust-osdev/Lobby).


<!--
TODO: Update publication date
-->
